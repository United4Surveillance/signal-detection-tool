

```{r libraries}
library(dplyr)
library(SignalDetectionTool)
```

```{r parameters}
if (is.null(params$data)) {
  data <- SignalDetectionTool::input_example
} 

```


# Data and Methods 

- Method used: `r names(params$algo)`
- Length of signal detection period: `r params$number_of_weeks` weeks
- Strata selected: `r paste(params$strata, collapse = ", ")`


```{r}

if (!is.null(params$signal_results)) {
  signal_results <- params$signal_results
} else {
  signal_results <- get_signals(data, 
                                method = params$algo, 
                                number_of_weeks = params$number_of_weeks)
  # TODO: get padded signals dataframe, needs function!
}



if (!is.null(strata) & is.null(params$signals_agg)) {
  results_strata <- get_signals(data, 
                                method = params$algo, 
                                stratification = params$strata,
                                number_of_weeks = params$number_of_weeks)
  signals_agg <- aggregate_signals(results_strata, 
                                   number_of_weeks = params$number_of_weeks)
} else if (!is.null(strata)) {
  signals_agg <- params$signals_agg
}


```


# Signal Detection 

```{r, results='asis'}
results_analysis <- signal_results %>% 
  dplyr::filter(is.na(category), 
                !is.na(alarms))

stringr::str_glue(
  "In the signal detection period - last {params$number_of_weeks} weeks available in the data - ", 
  "there where {sum(results_analysis$cases)} cases of {params$disease} in {params$country}. ",
  "Using the {params$algo} algorithm {sum(results_analysis$alarm)} signals where detected.")
```


```{r}
#| fig.cap=paste0("Number of ", params$disease, " cases by week and signals, ", params$country),
#| out.width="100%"

plot_time_series(signal_results %>% 
                   dplyr::filter(is.na(category)),
                 interactive = params$interactive)
```

```{r}

#| eval=sum(results_analysis$alarms, na.rm = TRUE) != 0
create_results_table(signal_results %>% 
                       dplyr::filter(is.na(category)), 
                     interactive = params$interactive)

```


