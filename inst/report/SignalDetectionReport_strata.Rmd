
```{r}
strat_text <- dplyr::case_when(strat == "age_group" ~ "agegroup",
                               TRUE ~ strat)

```


## Signals stratified by `r strat_text`

```{r, results='asis'}
results_analysis <- signals_agg %>% 
  dplyr::filter(any_alarms, 
                category %in% strat)

stringr::str_glue(
  "When stratifiying by {strat_text} the {params$algo} algorithm detects ", 
  "{sum(results_analysis$n_alarms)} signals in the signal detection period.")
```

```{r}
#| fig.cap=paste0("Number of ", params$disease, " cases and signals stratified by ", strat_text, ", ", params$country),
#| out.width="100%"
decider_barplot_map_table(signals_agg, 
                          data, 
                          strat,
                          interactive = params$interactive)
```

```{r}
df <- signal_results %>% 
  dplyr::filter(category %in% strat)

eval_ts_facet <- ((dplyr::n_distinct(df$stratum) <= 12))
p_height <- ceiling(dplyr::n_distinct(df$stratum)/2) * 2

```


```{r}
#| eval = eval_ts_facet,
#| fig.cap=paste0("Number of ", params$disease, " cases by week and signals stratified by ", strat_text, ", ", params$country),
#| fig.dim = c(8, p_height),
#| fig.fullwidth=TRUE
plot_time_series(df,
                 number_of_weeks = 52 * dplyr::n_distinct(df$stratum),
                 interactive = FALSE) + 
  ggplot2::facet_wrap(~stratum, ncol = 2)

```


```{r, eval = params$tables}
#| eval=sum(df$alarms, na.rm = TRUE) != 0
create_results_table(df %>% 
                       dplyr::select(-upperbound_pad, 
                                     -expected_pad, 
                                     -first_alarm_nonNA), 
                     interactive = params$interactive)
```


