---
title: "`r params$title`"
date: "`r {
i18n <- shiny.i18n::Translator$new(translation_json_path = 'translation.json')
i18n$set_translation_language(params$lang)
paste(i18n$t('report_generated_on'), Sys.Date())
}`"

params:
  data: NULL
  disease: "Pertussis"
  country: "Austria"
  number_of_weeks: 6
  strata: !r c("county_id", "community_id", "sex", "age_group") 
  signals_padded: NULL
  signals_agg: NULL
  intervention_date: NULL
  title: "Signal Detection Report"
  lang:
    label: "Language"
    value: "de"
    choices: ["de", "en"]
---

```{r}
# Make the branded bslib colors directly available
brand_colors <- bslib::bs_get_variables(
  bslib::bs_global_get() ,
  c(
    "bg",
    "primary",
    "success",
    "info",
    "warning",
    "danger"
  )
)
```


`r params$disease`
=====================================

<!-- Pathogen without stratification page -->
```{r}
i18n <- shiny.i18n::Translator$new(translation_json_path = 'translation.json')
i18n$set_translation_language(params$lang)
```

```{r}
# formatting pathogen name for links 
pate <- tolower(params$disease)  
pate <- gsub("[~(),./?&!#<>\\]", "", pate) #remove special characters
pate <- gsub("\\s", "-", pate) # replace space with score

s_agg <- params$signals_agg %>% 
  dplyr::filter(pathogen == params$disease)

s_pad <- params$signals_padded %>% 
  dplyr::filter(pathogen == params$disease)
```

```{r}
results_analysis <- s_pad %>%
  dplyr::filter(!is.na(alarms))
```

Row
-------------------------------------------------------------------------------

### `r i18n$t("number_of_cases")`
```{r}
flexdashboard::valueBox(value = sum(results_analysis$cases[is.na(results_analysis$category)]), 
         caption = sprintf(i18n$t("cases_of"), params$disease),
         color = brand_colors["info"])
```

### `r i18n$t("number_of_signals")`
```{r}
# signals across all strata
n_signals_week <- sum(results_analysis$alarms)

# max possible signals in assessment period
possible_signals <- sum(dplyr::count(s_agg, category) %>% dplyr::pull(n)) * params$number_of_weeks

n_signals_week_col <- ifelse(
  n_signals_week < 0.10 * possible_signals, brand_colors["success"],
  ifelse(n_signals_week < 0.50 * possible_signals, 
         brand_colors["warning"], brand_colors["danger"])
  )

flexdashboard::valueBox(value = n_signals_week,
  caption = sprintf(i18n$t("n_signals_weeks"), params$number_of_weeks),
  color = n_signals_week_col
)
```

`r if(!is.null(params$strata)) "Row {data-height=200}"`
`r if(!is.null(params$strata)) "-------------------------------------------------------------------------------"`

```{r, results='asis', eval=!is.null(params$strata)}
for(cate in params$strata){

  cate_link <- paste0("[", cate, "](",pate ,"-", cate, ".html)")
  cat("###", i18n$t("signals_in"), cate_link, "\n\n")
  
  p <- s_pad %>% 
    dplyr::filter(category == cate) %>% 
    plot_signals_per_week(interactive = TRUE, branding = brand_colors, partial = TRUE)
  
  print(htmltools::tagList(p))
  
  cat("\n\n")
}
```

`r if(!is.null(params$strata)) "Row {data-height=400}"`
`r if(!is.null(params$strata)) "-------------------------------------------------------------------------------"`

```{r, results='asis', eval=!is.null(params$strata)}
for(cate in params$strata){

  cate_link <- paste0("[", cate, "](",pate ,"-", cate, ".html)")
  cat("###", i18n$t("distribution_by"), cate_link, "\n\n")
  
  dist_plot <- decider_barplot_map_table(
     s_agg,
     params$data,
     cate,
     interactive = TRUE,
     partial = TRUE,
     translator = i18n
    ) 
  
  print(htmltools::tagList(dist_plot))
  
  cat("\n\n")
}
```

Row
-----------------------------------------------
### `r i18n$t("heading_unstratified_timeseries")`

```{r}
SignalDetectionTool::plot_time_series(
  s_pad %>%
    dplyr::filter(is.na(category)),
  intervention_date = params$intervention_date,
  interactive = TRUE,
  partial = TRUE
)
```

> `r sprintf(i18n$t("plot_caption_unstratified_timeseries"), params$disease, params$country)`

Row 
-------------------------------------
### `r i18n$t("heading_signal_detection_table")`

```{r}
txt <- NULL

if (sum(results_analysis$alarms, na.rm = TRUE) != 0) {
  SignalDetectionTool::build_signals_table(
    s_pad,
    format = "DataTable"
  )
} else {
  txt <- i18n$t("msg_no_signals_detected")
}
```

```{r, results='asis'}
#|eval = is.character(txt)

cat(txt)
```

<!-- Strata timeseries pages -->

```{r, results='asis', eval=FALSE}
if(!is.null(params$strata)){
  path_sdt_report_strata <- system.file("report","html_report", "SignalDetectionReport_strata.rmd", package = "SignalDetectionTool")
  src <- lapply(params$strata, function(j) {
    knitr::knit_expand(path_sdt_report_strata, 
                       strat = j, pathogen = "{{pathogen}}")
  })
  
  res <- knitr::knit_child(text = unlist(src), quiet = TRUE)
  cat(res, sep = "\n")
}
```

Row
-------------------------------------------------------------------------------
[`r i18n$t("go_back")`](../SignalDetectionReport.html)
