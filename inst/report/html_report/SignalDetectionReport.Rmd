---
title: "Signal Detection Report - `r params$country`"
date: "Report generated on `r Sys.Date()`"
lang: "en"


params: 
  data: NULL
  disease: "Pertussis"
  country: "Austria"
  number_of_weeks: 6
  method: "farrington"
  strata: !r c("county_id", "community_id", "sex", "age_group") 
  tables: true
  signals_padded: NULL
  signals_agg: NULL
  intervention_date: NULL

---


```{r, echo=FALSE}
knitr::opts_chunk$set(eval = TRUE, 
                      echo = FALSE, 
                      fig.align = 'center',
                      fig.width = 13,
                      fig.height = 5,
                      message = FALSE, 
                      warning = FALSE)
```

```{r include=FALSE}
# loading libraries in landing page level
library(dplyr)
library(SignalDetectionTool)
library(htmltools)
library(flexdashboard)
library(bslib)
```

```{r}
# Make the branded bslib colors directly available
brand_colors <- bs_get_variables(
  bs_current_theme() ,
  c(
    "brand-primary",
    "brand-success",
    "brand-info",
    "brand-warning",
    "brand-danger"
  )
)
```
<!-- Landing page -->

Landing Page
================================================================================

```{r}
# For calculating week of start and end
records <- signals_padded %>% 
  dplyr::filter(!is.na(alarms)) %>% 
  dplyr::count(year, week) %>% 
  dplyr::mutate(yearweek = sprintf("%d-W%02d", year, week))

# Selected pathogens
text_diseases <- ifelse(
  length(params$disease) == 1, 
  params$disease, 
  paste0(paste0(params$disease, collapse = ", "),
         ", ")
)

# selected stratifications
text_strata <- ""
if(length(params$strata) >= 1){
  text_strata <- ", as well as stratified by "
  if(length(params$strata) == 1){
    text_strata <- paste0(text_strata, params$strata)
  } else if(length(params$strata) == 2){
    text_strata <- paste0(text_strata,
                          params$strata[1], " and ", params$strata[2])
  } else {
    text_strata <- paste0(text_strata,
                          paste0(params$strata[1:(length(params$strata) - 1)],
                                 collapse = ", "), 
                          ", and ", tail(params$strata, 1))
  }
} 
```


This report contains an overview of signals observed for the period `r head(records$yearweek, 1)` to `r tail(records$yearweek, 1)` for `r text_diseases` in `r params$country`. The signals were calculated using the `r params$method` algorithm.

For each disease, you can find an unstratified overview of the observed signals`r text_strata`. 

```{r}
results_cases <- params$signals_padded %>% 
  dplyr::filter(!is.na(alarms)) %>% 
  dplyr::group_by(pathogen, category, stratum) %>% 
  dplyr::summarise(cases = sum(cases),
                   signals = sum(alarms))
```

For the last `r params$number_of_weeks` weeks there were:
  
```{r, results='asis'}
for(pat in params$disease){
  pat_link <- paste0("[", pat, "]")
  tmp <- results_cases %>% dplyr::filter(pathogen == pat, is.na(category))
  cat("-", tmp$cases, "cases of", pat_link, "\n")
  cat("\t -", tmp$signals, "signals (unstratified) \n")
  for(cate in params$strata){
    tmp <- results_cases %>% dplyr::filter(pathogen == pat, category == cate)
    cat("\t -", sum(tmp$signals), "signals stratified by", cate, "\n")
  }
}
```

Row
--------------------------------------------------------------
### Signals heatmap
```{r}
# following example from https://www.r-bloggers.com/2023/04/heatmap-formatting-of-a-table-with-dt/

# counts signals in category
tmp_df <- signals_padded %>%
  dplyr::filter(!is.na(alarms)) %>%
  dplyr::mutate(
    date = paste0("Y",year, ".W", week),
  ) %>% 
  dplyr::group_by(pathogen, category, date) %>%
  dplyr::summarise(signals = sum(alarms)) 

# dates
dates <- unique(tmp_df$date)

# add max possible signals per category
tmp_df <- tmp_df %>% 
  dplyr::left_join(signals_agg %>% dplyr::count(pathogen, category),
                   by = c("pathogen", "category")) %>%
  dplyr::mutate(signals_p = signals/n)


# generate colors
colsFunc <- colorRamp(c("white", "red"))
color_df <- tmp_df %>%
  dplyr::mutate(
    color = rgb(colsFunc(signals_p)[,1],
                colsFunc(signals_p)[,2],
                colsFunc(signals_p)[,3], 
                maxColorValue = 255)
  ) %>%
  dplyr::select(pathogen, category, date, color) %>%
  tidyr::pivot_wider(id_cols = c(pathogen, category),
                     names_from = date,
                     values_from = color)
  
# generate signals table
tmp_df <- tmp_df %>%
  dplyr::select(pathogen, category, date, signals) %>% 
  dplyr::mutate(
    pathogen = paste0("<a href='#", tolower(pathogen),"'>", pathogen,"</a>"),
    category = dplyr::case_when(
      is.na(category)~"Unstratified", 
      .default = category
    )
  ) %>% 
  tidyr::pivot_wider(id_cols = c(pathogen, category),
                     names_from = date,
                     values_from = signals) %>%
  dplyr::mutate(total = rowSums(dplyr::across(is.integer))) 


dt <- DT::datatable(
  tmp_df,
  rownames = FALSE,
  extensions = "RowGroup",
  options = list(
    rowGroup = list(dataSrc = list(0)),
    columnDefs = list(list(targets = 0, visible = FALSE)),
    paging = FALSE
  ),
  escape = FALSE
  )

# color columns
for(d in dates){
  dt <- dt %>% 
    DT::formatStyle(
      d, 
      backgroundColor = DT::styleEqual(tmp_df[[d]], color_df[[d]])
    )
}

dt
```

```{css, echo=FALSE}
/* Fix bug where data table shows only small table when bslib theme is used, see also https://github.com/rstudio/DT/issues/951 */
.datatables.html-widget.html-widget-static-bound { 
  height: auto !important;
  width: 90vw !important;
}
.dataTables_scrollBody {
  height: unset !important;
}
```

```{r, eval=FALSE}
# Links with plotly apparently don't work inside flexdashboard

tmp_df <- signals_padded %>%
  dplyr::filter(!is.na(alarms)) %>%
  dplyr::mutate(
    date = paste0("Y",year, ".W", week),
    category = dplyr::case_when(
      is.na(category)~"Unstratified", 
      .default = category
    )
  ) %>% 
  dplyr::group_by(pathogen, category, date) %>%
  dplyr::summarise(signals = sum(alarms)) 

split(tmp_df, tmp_df$pathogen) %>% 
  lapply(function(x){
    
    pat <- unique(x$pathogen)
    
    m <- matrix(x$signals, 
                nrow = length(params$strata)+1,
                ncol = params$number_of_weeks,
                byrow = T)
    
    rownames(m) <- unique(tmp_df$category)
    colnames(m) <- unique(tmp_df$date)
    
    plotly::plot_ly(x = colnames(m), y=rownames(m), z=m, type = "heatmap") %>%
       plotly::add_annotations(
         text = paste0("<a href='#", tolower(pat),"'>", pat,"</a>"), 
         x = -0.5,
         y = length(params$strata)+1,
         showarrow = FALSE, xref = "x", yref = "y", 
         font = list(size = 14)
       )
  }
  ) %>% 
  plotly::subplot(nrows = 3, shareX = TRUE)
```


<!-- Pathogen pages -->

```{r, results='asis'}
src <- lapply(params$disease, function(i) {
  knitr::knit_expand('SignalDetectionReport_body.rmd', 
                     pathogen = i)
})

res <- knitr::knit_child(text = unlist(src), quiet = TRUE)
cat(res, sep = "\n")
```




