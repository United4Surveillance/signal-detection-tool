---
title: "`r params$title`"
date: "`r {
i18n <- shiny.i18n::Translator$new(translation_json_path = 'translation.json')
i18n$set_translation_language(params$lang)
paste(i18n$t('report_generated_on'), Sys.Date())
}`"

params: 
  data: NULL
  disease: "Pertussis"
  country: "Austria"
  number_of_weeks: 6
  method: "farrington"
  strata: !r c("county_id", "community_id", "sex", "age_group") 
  signals_padded: NULL
  signals_agg: NULL
  intervention_date: NULL
  title: "Signal Detection Report"
  lang:
    label: "Language"
    value: "de"
    choices: ["de", "en"]

---
```{css, echo = FALSE}
.hidden{
display: none;
}
```

```{r, echo=FALSE}
knitr::opts_chunk$set(eval = TRUE, 
                      echo = FALSE, 
                      fig.align = 'center',
                      fig.width = 13,
                      fig.height = 5,
                      message = FALSE, 
                      warning = FALSE)
```

```{r include=FALSE}
# loading libraries in landing page level
library(dplyr)
library(SignalDetectionTool)
library(htmltools)
library(flexdashboard)
library(bslib)
library(shiny.i18n)
```

```{r, echo=FALSE}
# localisation
i18n <- Translator$new(translation_json_path = "translation.json")
i18n$set_translation_language(params$lang)

dt_options_language <- list(
      decimal        = i18n$t("datatable_decimal"),
      thousands      = i18n$t("datatable_thousands"),
      processing     = i18n$t("datatable_processing"),
      search         = i18n$t("datatable_search"),
      lengthMenu     = i18n$t("datatable_length_menu"),
      info           = i18n$t("datatable_info"),
      infoEmpty      = i18n$t("datatable_info_empty"),
      infoFiltered   = i18n$t("datatable_info_filtered"),
      infoPostFix    = i18n$t("datatable_info_postfix"),
      loadingRecords = i18n$t("datatable_loading_records"),
      zeroRecords    = i18n$t("datatable_zero_records"),
      emptyTable     = i18n$t("datatable_empty_table"),
      paginate = list(
        first    = i18n$t("datatable_paginate_first"),
        previous = i18n$t("datatable_paginate_previous"),
        `next`     = i18n$t("datatable_paginate_next"),
        last     = i18n$t("datatable_paginate_last")
      ),
      aria = list(
        sortAscending  = i18n$t("datatable_aria_sort_ascending"),
        sortDescending = i18n$t("datatable_aria_sort_descending")
      )
    )

```

```{r}
# Make the branded bslib colors directly available
brand_colors <- bs_get_variables(
  bs_global_get() ,
  c(
    "bg",
    "primary",
    "success",
    "info",
    "warning",
    "danger"
  )
)
```
<!-- Landing page -->

Landing Page
================================================================================

sidebar {.sidebar}
--------------------------------------------------------------------------------

```{r}
# For calculating week of start and end
records <- params$signals_padded %>% 
  dplyr::filter(!is.na(alarms)) %>% 
  dplyr::count(year, week) %>% 
  dplyr::mutate(yearweek = sprintf("%d-W%02d", year, week))

# Selected pathogens
text_diseases <- ifelse(
  length(params$disease) == 1, 
  params$disease, 
  ifelse(length(params$disease) == 2, 
         paste0(params$disease, collapse = " and "),
         paste0(length(params$disease), " pathogens (see list to the right)")
         )

)

```

``` {r}
# prepare Text of left sidebar

start_week <- head(records$yearweek, 1)
end_week   <- tail(records$yearweek, 1)

intro_paragraph <- glue::glue(
  i18n$t("report_sidebar_intro_paragraph"),
  start_week = start_week,
  end_week   = end_week,
  diseases   = text_diseases,
  country    = params$country,
  method     = params$method,
  .open = "{", .close = "}"
)

intro_unstratified <- i18n$t("report_sidebar_intro_unstratified")

if(length(params$strata) >= 1){
  text_strata <- glue::glue_collapse(params$strata, sep=", ",
                                     last=sprintf(" %s ", i18n$t("and")))
  intro_strata <- glue::glue(
    i18n$t("report_sidebar_intro_strata"),
    strata = text_strata,
    .open = "{", .close = "}")
  
  intro_strata <- paste0(intro_unstratified, ", ",
                         intro_strata, ".")
} else {
  intro_strata <- paste0(intro_unstratified, ".")
}

```
`r intro_paragraph`

`r intro_strata` 

```{r}
results_cases <- params$signals_padded %>% 
  dplyr::filter(!is.na(alarms)) %>% 
  dplyr::group_by(pathogen) %>% 
  dplyr::summarise(cases = sum(cases))
```

Row
--------------------------------------------------------------
### `r i18n$t("report_heading_summary")`
```{r}
# Summary all signals
tmp_df <- params$signals_padded %>%
  dplyr::filter(!is.na(alarms)) %>%
  dplyr::mutate(
    category = dplyr::case_when(
      is.na(category)~"Unstratified", 
      .default = category
      )
  ) %>% 
  dplyr::group_by(pathogen, category) %>%
  dplyr::summarise(signals = sum(alarms))

# max number of signals in category in period
maxsignals <- params$signals_agg %>% 
  dplyr::filter(pathogen == params$disease[1]) %>% 
  dplyr::group_by(category) %>% 
  dplyr::summarise(max_signals = n()*params$number_of_weeks) %>% 
  dplyr::mutate(
    category = dplyr::case_when(
      is.na(category)~"Unstratified", 
      .default = category
      )
  )
```

```{r, out.width="1000px"}
dt <- DT::datatable(
  tmp_df %>%
    tidyr::pivot_wider(
      id_cols = pathogen, 
      names_from = category,
      values_from = signals
    ) %>% 
    dplyr::right_join(results_cases, by = "pathogen") %>% 
    dplyr::relocate(cases, .after = "pathogen") %>% 
    dplyr::mutate(
      pathogen_f = tolower(pathogen),
      pathogen_f = gsub("[~(),./?&!#<>\\]", "", pathogen_f),
      pathogen_f = gsub("\\s", "-", pathogen_f), 
      pathogen = paste0("<a href='report_pages/", pathogen_f,".html'>", pathogen,"</a>"),
      total = rowSums(dplyr::across(is.integer))
    ) %>% 
    dplyr::select(-pathogen_f) %>% 
    dplyr::arrange(desc(total)),
  rownames = FALSE,
  escape = FALSE,
  caption = sprintf(i18n$t("report_summary_table_caption"), params$number_of_weeks),
  fillContainer = FALSE,
  class = list(stripe = FALSE),
  options = list(pageLength = 25,
                 language = dt_options_language)
  )

for(cate in c("Unstratified", strata)){
  # Calculates bins for colouring
  max_s <- maxsignals$max_signals[maxsignals$category == cate]
  cuts <- seq(0, max_s, length.out = 11)
  
  # colours for interpolate, uses brand color
  colours <- c(brand_colors["bg"], brand_colors["warning"], brand_colors["danger"])
  values <- colorRamp(colours, bias = log(0.2)/log(0.5))(cuts/max_s)   # bias transforms warning value to 20% 
  values <- rgb(values[,1],
                values[,2],
                values[,3], 
                maxColorValue = 255)
  
  # assign each column the colour formatting 
  dt <- dt %>% 
    DT::formatStyle(cate, 
    backgroundColor = DT::styleInterval(cuts[2:11], values)
    )
}

dt %>% DT::formatStyle("total", fontWeight = "bold")
```

<!-- Pathogen pages -->

```{r, results='asis', eval=FALSE}
path_sdt_report_body <- system.file("report","html_report", "SignalDetectionReport_body.rmd", package = "SignalDetectionTool")
src <- lapply(params$disease, function(i) {
  knitr::knit_expand(path_sdt_report_body, 
                     pathogen = i)
})

res <- knitr::knit_child(text = unlist(src), quiet = TRUE)
cat(res, sep = "\n")
```




